<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Distribution Sampling</title>
  <meta name="description" content="Algorithms such as AdaBoost impose a distribution over thedataset, i.e. there is a weight assigned to each record in the trainingdata. During the training of...">

  <!-- CSS -->
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/global.css">

  <!-- JS -->
  <script type="text/javascript" src="/MathJax/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  <!-- script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script -->

  <link rel="canonical" href="http://xstatic.chewning.co/algorithms/r/2016/01/31/distribution-sampling.html">
  <link rel="alternate" type="application/rss+xml" title="chewning.co" href="http://xstatic.chewning.co/feed.xml">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <!-- a class="site-title" href="/">chewning.co</a -->

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
          <a class="page-link" href="/index.html">&raquo; chewning.co</a> |
        
          
          <a class="page-link" href="/about/">about</a>
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Distribution Sampling</h1>
    <p class="post-meta"><time datetime="2016-01-31T23:28:57-05:00" itemprop="datePublished">01.31.16</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Algorithms such as <a href="https://en.wikipedia.org/wiki/AdaBoost">AdaBoost</a> impose a distribution over the
dataset, i.e. there is a weight assigned to each record in the training
data. During the training of this algorithm, these weights are either used
directly in the weak learners or they may be used to take bootstrap samples.
In the latter case we need a way to sample with replacement from our dataset of size <script type="math/tex">N</script>
subject to the distribution imposed by the weighting. 
Descriptions of these algorithms typically gloss over how this
weighted selection is actually done in practice.</p>

<p>To generalize this problem, the question we are asking is, given a
set of items <script type="math/tex">i</script> in dataset <script type="math/tex">D</script> of size <script type="math/tex">N</script>, where <script type="math/tex">i</script> is assigned weight <script type="math/tex">w_i</script>,
how can we sample from this distribution subject to these weights? If
<script type="math/tex">j</script> has weight <script type="math/tex">w_j=1</script> and <script type="math/tex">k</script> weight <script type="math/tex">w_k=2</script>, then we would
expect <script type="math/tex">k</script> to be independent randomly selected about twice as often
as <script type="math/tex">j</script>. More concretely, a die is uniformly distributed. If we sampled
from this distribution 60 times, we would expect to see each side of the
die about 10 times. If however, the die was biased, how can we sample
from this distribution, i.e. how can we <em>simulate</em> rolling the die?</p>

<p>From here on we assume that the the weights are normalized, that is</p>

<script type="math/tex; mode=display">w_i  \leftarrow \frac{w_i}{\sum_{j=1}^{N}w_j}.</script>

<p>We cannot directly select an item subject to the distribution. We can
however do so indirectly. Random number generators can easily provide
uniform distribution random numbers. We will leverage this to sample from an arbitrary distribution. 
Let <script type="math/tex">f(w)</script> indicate the weight distribution and its cumulative distribution
by <script type="math/tex">F(w)</script>. We uniformly generate a random number <script type="math/tex">r \in [0, 1]</script>. Now
we need find <script type="math/tex">w</script> such that <script type="math/tex">F(w)=r</script>, i.e. <script type="math/tex">w=F^{-1}(r)</script>, which is the inverse
function of <script type="math/tex">F</script> and not analytically solvable. For a discrete distribution this may be restated as</p>

<script type="math/tex; mode=display">\arg\max_{k} \sum_{i=1}^{k}w_i \le r.</script>

<p>For the implementation, it would be advantageous to memoize the
cumulative sum so this would not need to be calculated
for each sample. Also note that the cumulative sum is monotonic, so we could use
a binary search to find the argmax in question. Below is a generated
multi-modal distribution which we wish to sample.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="kn">library</span><span class="p">(</span>gtools<span class="p">)</span>
<span class="kn">library</span><span class="p">(</span>plyr<span class="p">)</span>

<span class="c1"># create a multi-modal distribution</span>
d1 <span class="o">&lt;-</span> <span class="kp">round</span><span class="p">(</span>rnorm<span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">50</span><span class="p">,</span> <span class="m">25</span><span class="p">))</span>
d2 <span class="o">&lt;-</span> <span class="kp">round</span><span class="p">(</span>rnorm<span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">100</span><span class="p">,</span> <span class="m">15</span><span class="p">))</span>

dist <span class="o">&lt;-</span> join<span class="p">(</span>count<span class="p">(</span>d1<span class="p">),</span> count<span class="p">(</span>d2<span class="p">),</span> by<span class="o">=</span><span class="s">&#39;x&#39;</span><span class="p">,</span> type<span class="o">=</span><span class="s">&#39;full&#39;</span><span class="p">)</span>

plot<span class="p">(</span>density<span class="p">(</span><span class="kp">rep</span><span class="p">(</span>dist<span class="o">$</span>x<span class="p">,</span> dist<span class="o">$</span>freq<span class="p">)),</span> col<span class="o">=</span><span class="s">&#39;lightblue&#39;</span><span class="p">,</span> lwd <span class="o">=</span> <span class="m">3</span><span class="p">)</span></code></pre></div>

<div align="center">
  <img src="/images/dist-orig.png" />
</div>

<p>Note that the modes of this distribution are around 50 and 100. So, if
we sampled a few numbers we would expect them to center around those values.
Below is the sampling code.</p>

<div class="highlight"><pre><code class="language-r" data-lang="r"><span class="c1"># normalize</span>
dist<span class="o">$</span>freq <span class="o">&lt;-</span> dist<span class="o">$</span>freq<span class="o">/</span><span class="kp">sum</span><span class="p">(</span>dist<span class="o">$</span>freq<span class="p">)</span>
dist <span class="o">&lt;-</span> dist<span class="p">[</span><span class="kp">order</span><span class="p">(</span>d<span class="o">$</span>x<span class="p">),</span> <span class="p">]</span>
dist<span class="o">$</span>dist <span class="o">&lt;-</span> dist<span class="o">$</span>x
<span class="c1"># cumulative distribution: F(w)</span>
dist<span class="o">$</span>cum.dist <span class="o">&lt;-</span> <span class="kp">cumsum</span><span class="p">(</span>dist<span class="o">$</span>freq<span class="p">)</span>

<span class="c1"># rand select func</span>
dist.select <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span>cum.dist<span class="p">,</span> target<span class="p">)</span> <span class="p">{</span>
  val <span class="o">&lt;-</span> binsearch<span class="p">(</span><span class="kr">function</span><span class="p">(</span>i<span class="p">)</span> <span class="p">{</span> cum.dist<span class="p">[</span>i<span class="p">]</span> <span class="p">},</span>
    <span class="m">1</span><span class="o">:</span><span class="kp">length</span><span class="p">(</span>cum.dist<span class="p">),</span>
    target<span class="o">=</span>target<span class="p">)</span><span class="o">$</span>where<span class="p">[</span><span class="m">2</span><span class="p">]</span>
  <span class="kr">if</span><span class="p">(</span><span class="kp">is.na</span><span class="p">(</span>val<span class="p">))</span> val <span class="o">&lt;-</span> <span class="m">1</span>
  val
<span class="p">}</span>
  
<span class="c1"># new selection subject to distribution; 100 samples</span>
new.dist <span class="o">&lt;-</span> <span class="kp">sapply</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">100</span><span class="p">,</span> FUN<span class="o">=</span><span class="kr">function</span><span class="p">(</span>idx<span class="p">)</span> <span class="p">{</span>
  d<span class="o">$</span>dist<span class="p">[</span>dist.select<span class="p">(</span>d<span class="o">$</span>cum.dist<span class="p">,</span> runif<span class="p">(</span><span class="m">1</span><span class="p">))]</span>
<span class="p">})</span>
 
<span class="c1"># distribution should be similar to the hist above</span>
plot<span class="p">(</span>density<span class="p">(</span>new.dist<span class="p">),</span> col<span class="o">=</span><span class="s">&#39;orange&#39;</span><span class="p">,</span> lwd <span class="o">=</span> <span class="m">3</span><span class="p">)</span></code></pre></div>

<p>Below is the distribution obtained from the sampling. You can see
that even with only 100 samples, the original and sampled distributions
are quite similar.</p>

<div align="center">
  <img src="/images/dist-sample.png" />
</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = 'http://chewning.co';
        this.page.identifier = 'distribution_sampling';
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//chewning.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>

<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">
    <div align="center" class="footer-text">
    This site is built from <a href="https://github.com/jekyll/jekyll">jekyll</a>.
    </div>
<!--
  <div class="wrapper">

    <h2 class="footer-heading">chewning.co</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>chewning.co</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/init-random"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">init-random</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/keithchewning"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">keithchewning</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Write an awesome description for your new site here. You can edit this line in _config.yml. It will appear in your document head meta (for Google search results) and in your feed.xml site description.
</p>
      </div>
    </div>

  </div>
-->
</footer>


  </body>

</html>
